#!/bin/bash

BACKUP_DIR="/var/lib/pgsql/backups"
LOG_DIR="/var/lib/pgsql/backup_logs"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_PATH="$BACKUP_DIR/full_backup_$TIMESTAMP"
LOG_FILE="$LOG_DIR/pg_basebackup_$TIMESTAMP.log"

mkdir -p $BACKUP_PATH
mkdir -p $LOG_DIR

# Run pg_basebackup with verbose flag (-v) and redirect output and errors to the log file
pg_basebackup -h localhost -U postgres -D $BACKUP_PATH -Fp -Xs -v -P > $LOG_FILE 2>&1

# Remove backups older than 7 days
find $BACKUP_DIR -maxdepth 1 -type d -name "full_backup_*" -mtime +7 -exec rm -rf {} \;

# Optional: Remove logs older than 30 days to save space
find $LOG_DIR -type f -name "pg_basebackup_*.log" -mtime +30 -exec rm -f {} \;

